---
layout: post
title: Hamlet, data models, and biterm topic modelling
date: 2020-09-29
tag: 
   - Text
description: XXX
image: /img/0179-interactions.svg
socialimage: http://freerangestats.info/img/0179-interactions.png
category: R
---

## You should all go watch Branagh's Hamlet (1996)

Earlier this year I watched [Kenneth Branagh's Hamlet (1996)](https://en.wikipedia.org/wiki/Hamlet_(1996_film)) and wow, I cannot recommend this movie enough. Not only is it by far the best Hamlet I have ever seen (on stage or screen), it has a fair claim to being the best Shakespeare I have seen, and makes it to my list of favourite films of any sort. Gorgeously filmed on 70 mm film (mostly around Blenheim Palace),  242 minutes long, brilliant direction, amazing atmosphere and ability to surface all the subplots and character quirks. Despite knowing the story backwards, having seen so many renderings of it, and every second line feeling like a quotation built into my cultural DNA, this film moved me in a new ways and depths that I rarely get from any work of art.

And yes, it does have a star-studded cast (perhaps excessively star-studded - Robin Williams and Gerard Depardieu seem wasted, and imagine using John Gielgud and Judi Dench for walk-on non-speaking parts), but the most important thing is that these people can really act. Branagh himself is a faultless tour-de-force, Kate Winslet is perfect as Ophelia, Julie Christie a wonderful Gertrude, and Derek Jacobi's Claudius is spot-on. Richard Briers seems to be made to play Polonius, with the perfect combination of humour, pomposity and pathos. Some of the greatness of the movie comes from seeing famous stars in what are sometimes seen as also-ran parts in ways that make you see both the greatness of both the role and the actor - Billy Crystal as a gravedigger, and Charlton Heston bringing dignity and depth to the leader of the players.

This interpretation of the movie plays up the role and dark aspects of Hamlet senior, whose statue broods over Elsinore and whose relationship to 'our' Hamlet is mirrored in Fortinbras senior and junior... but well, it's complicated, right? Which is the point.

Anyway, "do yourself a favour" as Molly Meldrum would have said, and see this movie.

Now, I need something stats-related if I am going to justify having a blog on this. So I thought I would tie my new-found enthusiasm for the full text of Hamlet with a familiarisation project that has been on my to-do list for months (understand biterm topic modelling) plus an interest in finding a generalisable, efficient way of representing text from a play in a tidy data model. So let's have a go.
 
## Tidying Hamlet

### Basic structure of the raw data

When I first download one of the five or more versions of Hamlet from the Gutenberg project, it looks like this:

```
[1] "HAMLET, PRINCE OF DENMARK"                                        
  [2] ""                                                                 
  [3] "by William Shakespeare"                                           
  [4] ""                                                                 
  [5] ""                                                                 
  [6] ""                                                                 
  [7] ""                                                                 
  [8] "PERSONS REPRESENTED."                                             
  [9] ""                                                                 
 [10] "Claudius, King of Denmark."                                       
 [11] "Hamlet, Son to the former, and Nephew to the present King."       
 [12] "Polonius, Lord Chamberlain."                                      
 [13] "Horatio, Friend to Hamlet."                                       
 [14] "Laertes, Son to Polonius."                                        
 [15] "Voltimand, Courtier."                                             
 [16] "Cornelius, Courtier."                                             
 [17] "Rosencrantz, Courtier."                                           
 [18] "Guildenstern, Courtier."                                          
 [19] "Osric, Courtier."                                                 
 [20] "A Gentleman, Courtier."                                           
 [21] "A Priest."                                                        
 [22] "Marcellus, Officer."                                              
 [23] "Bernardo, Officer."                                               
 [24] "Francisco, a Soldier"                                             
 [25] "Reynaldo, Servant to Polonius."                                   
 [26] "Players."                                                         
 [27] "Two Clowns, Grave-diggers."                                       
 [28] "Fortinbras, Prince of Norway."                                    
 [29] "A Captain."                                                       
 [30] "English Ambassadors."                                             
 [31] "Ghost of Hamlet's Father."                                        
 [32] ""                                                                 
 [33] "Gertrude, Queen of Denmark, and Mother of Hamlet."                
 [34] "Ophelia, Daughter to Polonius."                                   
 [35] ""                                                                 
 [36] "Lords, Ladies, Officers, Soldiers, Sailors, Messengers, and other"
 [37] "Attendants."                                                      
 [38] ""                                                                 
 [39] "SCENE. Elsinore."                                                 
 [40] ""                                                                 
 [41] ""                                                                 
 [42] ""                                                                 
 [43] "ACT I."                                                           
 [44] ""                                                                 
 [45] "Scene I. Elsinore. A platform before the Castle."                 
 [46] ""                                                                 
 [47] "[Francisco at his post. Enter to him Bernardo.]"                  
 [48] ""                                                                 
 [49] "Ber."                                                             
 [50] "Who's there?"                                                     
 [51] ""                                                                 
 [52] "Fran."                                                            
 [53] "Nay, answer me: stand, and unfold yourself."                      
 [54] ""                                                                 
 [55] "Ber."                                                             
 [56] "Long live the king!"                                              
 [57] ""                                                                 
 [58] "Fran."                                                            
 [59] "Bernardo?"                                                        
 [60] ""                                                                 
 [61] "Ber."                                                             
 [62] "He."                                                              
 [63] ""                                                                 
 [64] "Fran."                                                            
 [65] "You come most carefully upon your hour."                          
 [66] ""                                                                 
 [67] "Ber."                                                             
 [68] "'Tis now struck twelve. Get thee to bed, Francisco."              
 [69] ""                                                                 
 [70] "Fran."                                                            
 [71] "For this relief much thanks: 'tis bitter cold,"                   
 [72] "And I am sick at heart."                                          
 [73] ""                                                                 
 [74] "Ber."                                                             
 [75] "Have you had quiet guard?"                                        
 [76] ""                                                                 
 [77] "Fran."                                                            
 [78] "Not a mouse stirring."                                            
 [79] ""                                                                 
 [80] "Ber."                                                             
 [81] "Well, good night."                                                
 [82] "If you do meet Horatio and Marcellus,"                            
 [83] "The rivals of my watch, bid them make haste."                     
 [84] ""                                                                 
 [85] "Fran."                                                            
 [86] "I think I hear them.--Stand, ho! Who is there?"                   
 [87] ""                                                                 
 [88] "[Enter Horatio and Marcellus.]"                                   
 [89] ""                                                                 
 [90] "Hor."                                                             
 [91] "Friends to this ground."                                          
 [92] ""                                                                 
 [93] "Mar."                                                             
 [94] "And liegemen to the Dane."                                        
 [95] ""                                                                 
 [96] "Fran."                                                            
 [97] "Give you good-night."                                             
 [98] ""                                                                 
 [99] "Mar."                                                             
[100] "O, farewell, honest soldier;"  
```

So this is interesting. Here are some things we need to take into account in putting this into a data model that loses no or minimal information from its structure and content:

- We have about 40 lines of preamble, then we are on to a combination of dialogue and stage directions. 
- The play is structured into Acts and Scenes. Scenes have numbers and descriptions (eg `Scene I. Elsinore. A platform before the Castle.`) but Acts just have numbers. Scenes are strictly hierarchically ordered under Acts (ie there is no Scene that continues over the boundary between two Acts).
- The stage directions are in square brackets `[Enter Horatio and Marcellus]`. A stage direction can be seen as applying until it is countermanded (for example, once Francisco and Bernardo have entered, they should be considered as present on stage until we are told otherwise)
- A continuous line of speech can go over several lines, such as Francisco in lines 71 and 72 of the above. The line breaks may be significant (and sometimes certainly are when the line is in verse), or not.
- The character speaking is referred to be abbrevaition (eg `Fran.`), which needs decoding to be fully human-readable (an actor learning the play, or a reader familiar with it would know that `Hor.` is Horatio, but only by mental decoding - something that should be done in the data model)

Here is the R code that sets up my session, including preparation for things I haven't talked about yet, downloads the play and gets us to this point:

*Post continues below R code*
{% highlight R lineanchors %}
library(tidyverse)
library(tidytext)
library(gutenbergr)
library(SnowballC)
library(tidygraph)
library(ggraph)
library(Cairo)
library(BTM)
library(textplot)
library(concaveman)


# TODO - a problem with lines 6380:6381 which has a stage direction across two lines.


#' Replace NA values in a vector with counting from the previous value
#' 
#' @param x a vector character
#' @examples 
#' replace_na_with_num(c(1,1,1,1, NA, NA, 1, 1, 1, NA))
replace_na_with_num <- function(x){
  # I can't think of a way to do this next operation without a loop because there is iteration
  for(i in 2:length(x)){
    if(is.na(x[i])){
      x[i] <- x[i-1] + 1
    }
  }
  return(x)
}
stopifnot(replace_na_with_num(c(1,1,1,NA, NA, 1, NA)) == c(1,1,1,2,3,1,2))

# There seem to be two Shakespeares, definitely duplicates:
filter(gutenberg_authors, grepl("Shakespeare", author))

# At least five versions of Hamlet
filter(gutenberg_metadata, grepl("Hamlet", title) & 
         author == "Shakespeare, William" &
         grepl("Public domain", rights) &
         language == "en") %>%
  select(gutenberg_id, title, gutenberg_bookshelf)

# I'll download the first mentioned. May not be the best.
hamlet <- gutenberg_download(1524) %>%
  mutate(original_line_number = 1:n()) %>%
  select(-gutenberg_id)

hamlet %>%
  select(text) %>%
  slice(1:100) %>%
  pull(text)
{% endhighlight %}

### Stage directions

With one annoying exception, the stage directions are all single lines so we can pick them up easily with a regular expression that looks for lines that begin and finish in square brackets.

```
> # Number of times each stage direction used
> hamlet %>%
+   filter(grepl("^\\[.*\\]$", text)) %>%
+   count(text, name = "times_used", sort = TRUE) 
# A tibble: 129 x 2
   text                                   times_used
   <chr>                                       <int>
 1 [Exit.]                                        19
 2 [Exeunt.]                                      13
 3 [Sings.]                                       11
 4 [Enter Polonius.]                               5
 5 [Exit Polonius.]                                5
 6 [Enter Hamlet.]                                 4
 7 [Exeunt Rosencrantz and Guildenstern.]          4
 8 [Dies.]                                         3
 9 [Enter Rosencrantz and Guildenstern.]           3
10 [Exit Ghost.]                                   3
```

Here is the exception - it comes from near the end, when a whole bunch of people (too many to list in a single line) come in with weapons to be used in the duel between Hamlet and Laertes:

{% highlight R lineanchors %}
> hamlet[6380:6381, ]
# A tibble: 2 x 2
  text                                                           original_line_number
  <chr>                                                                         <int>
1 [Enter King, Queen, Laertes, Lords, Osric, and Attendants with                 6380
2 foils &c.]                                                                     6381
{% endhighlight %}

### Scenes and Acts

Similarly, we can use regular expression to find with nearly 100% accuracy the beginnings of Scenes and Acts. Note that the capitalisation of `Act` is inconsistent:

```
> # Scenes and acts. Sometimes upper case sometimes not
> hamlet %>%
+   filter(grepl("^Scene\\s", text, ignore.case = TRUE) | grepl("^Act\\s", text, ignore.case = TRUE))
# A tibble: 26 x 2
   text                                               original_line_number
   <chr>                                                             <int>
 1 ACT I.                                                               43
 2 Scene I. Elsinore. A platform before the Castle.                     45
 3 Scene II. Elsinore. A room of state in the Castle.                  378
 4 Scene III. A room in Polonius's house.                              822
 5 Scene IV. The platform.                                            1029
 6 Scene V. A more remote part of the Castle.                         1211
 7 Act II.                                                            1560
 8 Scene I. A room in Polonius's house.                               1562
 9 Scene II. A room in the Castle.                                    1779
10 ACT III.                                                           2744
# ... with 16 more rows
```


### Character names

Generally, a line indicating a new speaker can be identified by the pattern of "capital letter - lower case letters - full stop - end of line". So it is straightforward to pull out lines that meet this pattern with a regular expression and count them:

```
> hamlet %>%
+   filter(grepl("^[A-Z][a-z]+\\.$", text)) %>%
+   count(text, name= "number_speeches", sort = TRUE) %>%
+   slice(1:20)
# A tibble: 20 x 2
   text   number_speeches
   <chr>            <int>
 1 Ham.               358
 2 Hor.               108
 3 King.              102
 4 Pol.                86
 5 Queen.              69
 6 Laer.               62
 7 Oph.                57
 8 Ros.                45
 9 Mar.                31
10 Guil.               29
11 Osr.                25
12 Ber.                19
13 Ghost.              14
14 Rey.                13
15 Fran.                8
16 Capt.                7
17 Fort.                4
18 All.                 3
19 Danes.               3
20 Gent.                3
```

358 lines to learn if you want to play Hamlet, versus (for example) 29 for Guildenstern. Basically that simple search-and-count works, although there are annoyingly some context-specific uses of `Both.` and `All.`; and there are a few spoken lines (`Farewell.` and `Good.`) that get mixed up into this pattern. It's very difficult to identify an algorithm that can tell these apart, particularly because (for example) `Good.` is a plausible abbreviation of a character name. I think only a human could be sure of the difference in a specific context, so we will need a bit of careful manual coding of some parts.

To decode abbreviations into character names and add some useful metadata for later, I created by hand a vector of the eight main characters (using my human interpretation to decide on what constituted "main"), and table that relates the abbreviations (`King.`, etc) to full names of the character ("Claudius, King of Denmark.") and human-friendly abbreviations for plots and the like using the term more commonly used today ("Claudius").

I also made a vector of words that looked like character names and feature as single word lines in the play but aren't referring to characters: `No.`, `Dead.`, `He.`, etc.

{% highlight R lineanchors %}
#==================Processing========================
main_chars <- c("Hamlet", "Horatio", "Claudius", "Gertrude", "Ophelia", "Polonius", "Laertes", "Ghost")
# These aren't the top 8 characters - First gravedigger and Rosencrantz both have more words than Ghost -
# but seem the 8 most fully-rounded real people.

personae <- tribble(~speaker, ~speaker_abb, ~speaker_sh,
                     "Claudius, King of Denmark.", "King.", "Claudius",
                     "Hamlet, Son to the former, and Nephew to the present King.", "Ham.", "Hamlet",
                     "Polonius, Lord Chamberlain.", "Pol.", "Polonius",
                     "Horatio, Friend to Hamlet.", "Hor.",             "Horatio",                 
                     "Laertes, Son to Polonius.", "Laer.", "Laertes",
                     "Voltimand, Courtier.", "Volt.", "Voltimand",
                     "Cornelius, Courtier.", "???",               "Cornelius",                      
                     "Rosencrantz, Courtier.", "Ros.",                        "Rosencrantz",               
                     "Guildenstern, Courtier.", "Guil.",                                  "Guildenstern",
                     "Osric, Courtier.", "Osr.",                                "Osric",
                     "A Gentleman, Courtier.", "Gent.", "Gentleman",
                     "Marcellus, Officer.", "Mar.", "Marcellus",
                     "Bernardo, Officer.", "Ber.",              "Bernardo",                         
                     "Francisco, a Soldier", "Fran.",                      "Francisco",                
                     "Reynaldo, Servant to Polonius.", "Rey.","Reynaldo",
                     "Players", "Players.",                            "Players",
                     "Fortinbras, Prince of Norway.", "For.", "Fortinbras",
                     "Fortinbras, Prince of Norway.", "Fort.", "Fortinbras",
                     "A Captain.", "Capt.",                                 "Captain",              
                     "English Ambassador 1.", "1 Ambassador.", "English Ambassador",
                     "Ghost of Hamlet's Father.", "Ghost.", "Ghost",
                     "Gertrude, Queen of Denmark, and Mother of Hamlet.", "Queen.", "Gertrude",
                     "Ophelia, Daughter to Polonius.", "Oph.", "Ophelia",
                     "Prologue to The Murder of Gonzago, a play within a play", "Pro.", "Player prologue",
                      "King in The Murder of Gonzago, a play within a play", "P. King.", "Player King",
                    "Queen in The Murder of Gonzago, a play within a play", "P. Queen.", "Player Queen",
                      "Lucianus, nephew to the King in play within a play", "Luc.", "Lucianus",
                    "Danes", "Danes.", "Danes",
                    "Servant", "Servant.", "Servant",
                    "Sailor", "Sailor.", "Sailor",
                    "Messenger", "Mess.", "Messenger",
                    "First gravedigger clown", "1 Clown.", "First gravedigger",
                    "Second gravedigger clown", "2 Clown.", "Second gravedigger",
                    "First priest", "1 Priest.", "First Priest",
                    "Second priest", "2 Priest.", "Second Priest",
                    "Danish courtier lord", "Lord.", "Lord",
                    # There are 3 uses of 'All.', in each case mean different groups
                    "All present on stage", "All.", "All",
                    # only two uses of 'Both.', near the beginning:
                    "Marcellus and Bernardo together", "Both.", "Marcellus and Bernardo") %>%
  mutate(main_character = speaker_sh %in% main_chars)

not_people <- c("He.", "Say.", "Farewell.", "Perpend.", "Nothing.", "Good.", "Swear.", "No.", "Dead.", "One.")


# This chunk of code was how I identified the abbreviations that weren't in the original list of personae
# (eg "1 Clown."), and also refined the list above of not_people.
hamlet %>%
  slice(-(1:38)) %>%
  mutate(speaker_abb = case_when(
    # Most people picked up by this
    grepl("^[A-Z][a-z]+\\.$", text)         ~ text,
    # "1 Ambassador", "2 Clown" and similar are picked up by this:
    grepl("^[1-9]\\s[A-Z][a-z]+\\.$", text) ~ text,
    # P. King. etc picked up by this:
    grepl("^[A-Z]\\.\\s[A-Z][a-z]+\\.$", text) ~ text
    )) %>%
  filter(text != "") %>%
  mutate(speaker_abb = if_else(speaker_abb %in% not_people, NA_character_, speaker_abb)) %>%
  fill(speaker_abb) %>%
  filter(!is.na(speaker_abb)) %>%
  anti_join(personae, by = "speaker_abb")
{% endhighlight %}

### A table of data with "spoken line" as grain

I use these lookup tables and vectors to create my first tidier version of the data, `hamlet_lines`. This object is shown below. In this version, each row of the table is a complete line of dialogue. Rows of the original data that are not dialogue buyt refer to the Act, Scene, stage direction or who is speaking have been pivoted wider to appear as columns such as `speaker`, `last_stage_direction`, `act` and `scene`. Here is how that object looks:

```
> hamlet_lines
# A tibble: 3,945 x 11
   text        original_line_nu~ speaker_abb speaker   speaker_sh main_character last_stage_direction act    scene      new_speaker_thi~ line_number_thi~
   <chr>                   <int> <chr>       <chr>     <chr>      <lgl>          <chr>                <chr>  <chr>      <lgl>                       <dbl>
 1 Who's ther~                50 Ber.        Bernardo~ Bernardo   FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 2 Nay, answe~                53 Fran.       Francisc~ Francisco  FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 3 Long live ~                56 Ber.        Bernardo~ Bernardo   FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 4 Bernardo?                  59 Fran.       Francisc~ Francisco  FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 5 He.                        62 Ber.        Bernardo~ Bernardo   FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 6 You come m~                65 Fran.       Francisc~ Francisco  FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 7 'Tis now s~                68 Ber.        Bernardo~ Bernardo   FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 8 For this r~                71 Fran.       Francisc~ Francisco  FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
 9 And I am s~                72 Fran.       Francisc~ Francisco  FALSE          Francisco at his po~ ACT I. Scene I. ~ FALSE                           2
10 Have you h~                75 Ber.        Bernardo~ Bernardo   FALSE          Francisco at his po~ ACT I. Scene I. ~ TRUE                            1
# ... with 3,935 more rows
```

Note that we have kept the successive lines of text by a single character as per the original - for instance rows 71 and 72 of the original data, spoken by Fancisco, are now rows 8 and 9 but are still two separate rows. A logical flag `new_speaker_this_line` helps us identify such cases for future.

Here's the chunk of code that creates this table, with "line" as its granularity, from the original messy data. Most of this code is dealing with various quirks in the data, such as `2 Clown` (for "second clown", or second gravedigger) having a different structure of character abbreviation from most of the roles.

{% highlight R lineanchors %}
hamlet_lines <- hamlet %>%
  slice(-(1:39)) %>%
  # Identify the speaker:
  mutate(speaker_abb = case_when(
    # Most people picked up by this
    grepl("^[A-Z][a-z]+\\.$", text)         ~ text,
    # "1 Ambassador", "2 Clown" and similar are picked up by this:
    grepl("^[1-9]\\s[A-Z][a-z]+\\.$", text) ~ text,
    # P. King. etc picked up by this:
    grepl("^[A-Z]\\.\\s[A-Z][a-z]+\\.$", text) ~ text
  )) %>%
  filter(text != "") %>%
  mutate(speaker_abb = if_else(speaker_abb %in% not_people, NA_character_, speaker_abb)) %>%
  fill(speaker_abb) %>%
  filter(is.na(speaker_abb) | text != speaker_abb) %>%
  left_join(personae, by = "speaker_abb") %>%
  # Identify stage directions:
  mutate(last_stage_direction = case_when(
         grepl("^\\[.*\\]$", text) ~ text
  )) %>%
  fill(last_stage_direction) %>%
  filter(is.na(last_stage_direction) | text != last_stage_direction) %>%
  mutate(last_stage_direction = gsub("[", "", last_stage_direction, fixed = TRUE),
         last_stage_direction = gsub("]", "", last_stage_direction, fixed = TRUE)) %>%
  # Identify Act:
  mutate(act = case_when(
    grepl("^A[Cc][Tt]\\s", text) ~ text
  )) %>%
  fill(act) %>%
  filter(is.na(act) | text != act) %>%
  # Identify Scene
  mutate(scene = case_when(
    grepl("^S[Cc][Ee][Nn][Ee]\\s", text) ~ text
  )) %>%
  fill(scene) %>%
  filter(is.na(scene) | text != scene) %>%
  # regularise some spelling:
  mutate(scene = gsub("Castle", "castle", scene)) %>%
  # identify the actual speeches and count the lines in each speech by a continuing speaker
  mutate(new_speaker_this_line = is.na(lag(speaker)) | speaker != lag(speaker),
         line_number_this_speech = ifelse(new_speaker_this_line, 1, NA),
         line_number_this_speech = replace_na_with_num(line_number_this_speech))
{% endhighlight %}

This tidy table of data, at the granularity of line of dialogue, makes it easy to count lines per speaker, Act, Scene, etc. For example, we can see that Act II, Scene II has the most spoken lines (590):

```
> count(hamlet_lines, act, scene)
# A tibble: 20 x 3
   act      scene                                                  n
   <chr>    <chr>                                              <int>
 1 ACT I.   Scene I. Elsinore. A platform before the castle.     190
 2 ACT I.   Scene II. Elsinore. A room of state in the castle.   280
 3 ACT I.   Scene III. A room in Polonius's house.               141
 4 ACT I.   Scene IV. The platform.                              101
 5 ACT I.   Scene V. A more remote part of the castle.           212
 6 Act II.  Scene I. A room in Polonius's house.                 130
 7 Act II.  Scene II. A room in the castle.                      590
 8 ACT III. Scene I. A room in the castle.                       196
 9 ACT III. Scene II. A hall in the castle.                      383
10 ACT III. Scene III. A room in the castle.                     102
11 ACT III. Scene IV. Another room in the castle.                236
12 ACT IV.  Scene I. A room in the castle.                        46
13 ACT IV.  Scene II. Another room in the castle.                 28
14 ACT IV.  Scene III. Another room in the castle.                71
15 ACT IV.  Scene IV. A plain in Denmark.                         68
16 ACT IV.  Scene V. Elsinore. A room in the castle.             228
17 ACT IV.  Scene VI. Another room in the castle.                 29
18 ACT IV.  Scene VII. Another room in the castle.               212
19 ACT V.   Scene I. A churchyard.                               283
20 ACT V.   Scene II. A hall in the castle.                      419
```

### A table of data with "spoken word" as grain

My next step is to make a table or data frame with *spoken word* as the grain. Here I want not just bags of words, but the original sequence preserved, and whether a word was originally at the beginning of a line, as well as who is speaking (and all the different abbreviations of their name and groups that person belongs to), the last stage direction, the Act and Scene, etc. For future use I also want stemmed version of each word (eg so "answered", "answering" and "answers" all reduce to their stem "answer"), and a flag of whether each word is a stop word or not.

Here's how that table is going to look, capturing all 30,000 or so words spoken in the uncut version of Hamlet"

```
> hamlet_words %>% select(contains("word"), everything())
# A tibble: 30,022 x 20
   word  stopword word_stem new_speaker_thi~ word_number_thi~ word_number word_number_thi~ word_number_thi~ original_line_n~ speaker_abb
   <chr> <lgl>    <chr>     <lgl>                       <dbl>       <int>            <int>            <int>            <int> <chr>      
 1 who's TRUE     who'      TRUE                            1           1                1                1               50 Ber.       
 2 there TRUE     there     FALSE                           2           2                2                2               50 Ber.       
 3 nay   FALSE    nai       TRUE                            1           3                3                3               53 Fran.      
 4 answ~ FALSE    answer    FALSE                           2           4                4                4               53 Fran.      
 5 me    TRUE     me        FALSE                           3           5                5                5               53 Fran.      
 6 stand FALSE    stand     FALSE                           4           6                6                6               53 Fran.      
 7 and   TRUE     and       FALSE                           5           7                7                7               53 Fran.      
 8 unfo~ FALSE    unfold    FALSE                           6           8                8                8               53 Fran.      
 9 your~ TRUE     yourself  FALSE                           7           9                9                9               53 Fran.      
10 long  FALSE    long      TRUE                            1          10               10               10               56 Ber.       
# ... with 30,012 more rows, and 10 more variables: speaker <chr>, speaker_sh <fct>, main_character <lgl>, last_stage_direction <chr>,
#   act <chr>, scene <chr>, new_speaker_this_line <lgl>, line_number_this_speech <dbl>, speech_number <int>, top_20_char <lgl>
```

And here is how I made that table out of the `hamlet_lines`

{% highlight R lineanchors %}
# Make up a set of stopwords.
# The cncept of stopwords seems a bit arbitrary. Why aren't "shall", "go", "us" and "one" 
# already stopwords in the snowball lexicon whereas "i", "our" are?
our_stopwords <- tibble(word = c(
  "thou", "thine", "o", "tis", "thee", "thy", "sir", "hath", "lord", "us", "one"
)) %>%
  mutate(lexicon = "made up") %>%
  rbind(get_stopwords())

# First iteration of data frame with word as grain  
hamlet_words <- hamlet_lines %>%
  tidytext::unnest_tokens(output ="word", input = "text") %>%
  left_join(our_stopwords, by = "word") %>%
  mutate(stopword = !is.na(lexicon)) %>%
  select(-lexicon) %>%
  mutate(word_stem = wordStem(word)) %>%
  # identify the actual speeches and count the words in each speech by a continuing speaker
  mutate(new_speaker_this_word = is.na(lag(speaker)) | speaker != lag(speaker),
         word_number_this_speech = ifelse(new_speaker_this_word, 1, NA),
         word_number_this_speech = replace_na_with_num(word_number_this_speech)) %>%
  mutate(word_number = 1:n()) %>%
  group_by(act) %>%
  mutate(word_number_this_act = 1:n()) %>%
  group_by(act, scene) %>%
  mutate(word_number_this_scene = 1:n()) %>%
  ungroup()

# Identify if starting a speech or not...
words_starting_speeches <- hamlet_words %>%
  filter(new_speaker_this_word) %>%
  select(word_number) %>%
  mutate(speech_number = 1:n())

# ... and rejoin to the original:
hamlet_words <- hamlet_words %>%
  left_join(words_starting_speeches, by = "word_number") %>%
  fill(speech_number) 

# words per speaker:
char_summary <- hamlet_words %>%
  group_by(speaker_sh) %>%
  summarise(words = n(),
            speeches = sum(new_speaker_this_line),
            words_per_speech = words / speeches,
            stopwords = sum(stopword),
            prop_non_stop = 1 - stopwords / words,
            most_words_single_speech = max(word_number_this_speech)) %>%
  arrange(desc(words))

# are you one of the top 20 speakers?...
top_20_chars <- char_summary[1:20, ]$speaker_sh


# ... and rejoin to the original:
hamlet_words <- hamlet_words %>%
  mutate(top_20_char = speaker_sh %in% top_20_chars,
         speaker_sh = factor(speaker_sh, levels = char_summary$speaker_sh))
{% endhighlight %}

You might have noticed that `char_summary` data frame I make along the way there. It has some summary information on each character such as the number of words and speeches, words per speech, stop words, proportion of words that aren't stopwords, etc. Here's what that looks like

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> speaker_sh </th>
   <th style="text-align:right;"> words </th>
   <th style="text-align:right;"> speeches </th>
   <th style="text-align:right;"> words_per_speech </th>
   <th style="text-align:right;"> stopwords </th>
   <th style="text-align:right;"> prop_non_stop </th>
   <th style="text-align:right;"> most_words_single_speech </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Hamlet </td>
   <td style="text-align:right;"> 11907 </td>
   <td style="text-align:right;"> 2645 </td>
   <td style="text-align:right;"> 4.501701 </td>
   <td style="text-align:right;"> 6412 </td>
   <td style="text-align:right;"> 0.4614932 </td>
   <td style="text-align:right;"> 473 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Claudius </td>
   <td style="text-align:right;"> 4116 </td>
   <td style="text-align:right;"> 610 </td>
   <td style="text-align:right;"> 6.747541 </td>
   <td style="text-align:right;"> 2189 </td>
   <td style="text-align:right;"> 0.4681730 </td>
   <td style="text-align:right;"> 392 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Polonius </td>
   <td style="text-align:right;"> 3017 </td>
   <td style="text-align:right;"> 612 </td>
   <td style="text-align:right;"> 4.929739 </td>
   <td style="text-align:right;"> 1661 </td>
   <td style="text-align:right;"> 0.4494531 </td>
   <td style="text-align:right;"> 241 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Horatio </td>
   <td style="text-align:right;"> 2034 </td>
   <td style="text-align:right;"> 650 </td>
   <td style="text-align:right;"> 3.129231 </td>
   <td style="text-align:right;"> 1128 </td>
   <td style="text-align:right;"> 0.4454277 </td>
   <td style="text-align:right;"> 225 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Laertes </td>
   <td style="text-align:right;"> 1463 </td>
   <td style="text-align:right;"> 348 </td>
   <td style="text-align:right;"> 4.204023 </td>
   <td style="text-align:right;"> 764 </td>
   <td style="text-align:right;"> 0.4777854 </td>
   <td style="text-align:right;"> 274 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ophelia </td>
   <td style="text-align:right;"> 1163 </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 2.974425 </td>
   <td style="text-align:right;"> 661 </td>
   <td style="text-align:right;"> 0.4316423 </td>
   <td style="text-align:right;"> 125 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Gertrude </td>
   <td style="text-align:right;"> 1084 </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 2.772378 </td>
   <td style="text-align:right;"> 561 </td>
   <td style="text-align:right;"> 0.4824723 </td>
   <td style="text-align:right;"> 137 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> First gravedigger </td>
   <td style="text-align:right;"> 741 </td>
   <td style="text-align:right;"> 310 </td>
   <td style="text-align:right;"> 2.390323 </td>
   <td style="text-align:right;"> 421 </td>
   <td style="text-align:right;"> 0.4318489 </td>
   <td style="text-align:right;"> 76 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Rosencrantz </td>
   <td style="text-align:right;"> 695 </td>
   <td style="text-align:right;"> 366 </td>
   <td style="text-align:right;"> 1.898907 </td>
   <td style="text-align:right;"> 411 </td>
   <td style="text-align:right;"> 0.4086331 </td>
   <td style="text-align:right;"> 103 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ghost </td>
   <td style="text-align:right;"> 682 </td>
   <td style="text-align:right;"> 68 </td>
   <td style="text-align:right;"> 10.029412 </td>
   <td style="text-align:right;"> 332 </td>
   <td style="text-align:right;"> 0.5131965 </td>
   <td style="text-align:right;"> 375 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Marcellus </td>
   <td style="text-align:right;"> 429 </td>
   <td style="text-align:right;"> 183 </td>
   <td style="text-align:right;"> 2.344262 </td>
   <td style="text-align:right;"> 228 </td>
   <td style="text-align:right;"> 0.4685315 </td>
   <td style="text-align:right;"> 80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Osric </td>
   <td style="text-align:right;"> 358 </td>
   <td style="text-align:right;"> 176 </td>
   <td style="text-align:right;"> 2.034091 </td>
   <td style="text-align:right;"> 200 </td>
   <td style="text-align:right;"> 0.4413408 </td>
   <td style="text-align:right;"> 64 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Player King </td>
   <td style="text-align:right;"> 337 </td>
   <td style="text-align:right;"> 34 </td>
   <td style="text-align:right;"> 9.911765 </td>
   <td style="text-align:right;"> 154 </td>
   <td style="text-align:right;"> 0.5430267 </td>
   <td style="text-align:right;"> 233 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Guildenstern </td>
   <td style="text-align:right;"> 323 </td>
   <td style="text-align:right;"> 193 </td>
   <td style="text-align:right;"> 1.673575 </td>
   <td style="text-align:right;"> 206 </td>
   <td style="text-align:right;"> 0.3622291 </td>
   <td style="text-align:right;"> 43 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Player Queen </td>
   <td style="text-align:right;"> 238 </td>
   <td style="text-align:right;"> 31 </td>
   <td style="text-align:right;"> 7.677419 </td>
   <td style="text-align:right;"> 112 </td>
   <td style="text-align:right;"> 0.5294118 </td>
   <td style="text-align:right;"> 102 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Fortinbras </td>
   <td style="text-align:right;"> 222 </td>
   <td style="text-align:right;"> 32 </td>
   <td style="text-align:right;"> 6.937500 </td>
   <td style="text-align:right;"> 113 </td>
   <td style="text-align:right;"> 0.4909910 </td>
   <td style="text-align:right;"> 98 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Bernardo </td>
   <td style="text-align:right;"> 205 </td>
   <td style="text-align:right;"> 96 </td>
   <td style="text-align:right;"> 2.135417 </td>
   <td style="text-align:right;"> 109 </td>
   <td style="text-align:right;"> 0.4682927 </td>
   <td style="text-align:right;"> 35 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Gentleman </td>
   <td style="text-align:right;"> 192 </td>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:right;"> 10.666667 </td>
   <td style="text-align:right;"> 86 </td>
   <td style="text-align:right;"> 0.5520833 </td>
   <td style="text-align:right;"> 104 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Voltimand </td>
   <td style="text-align:right;"> 149 </td>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> 21.285714 </td>
   <td style="text-align:right;"> 73 </td>
   <td style="text-align:right;"> 0.5100671 </td>
   <td style="text-align:right;"> 149 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Second gravedigger </td>
   <td style="text-align:right;"> 98 </td>
   <td style="text-align:right;"> 78 </td>
   <td style="text-align:right;"> 1.256410 </td>
   <td style="text-align:right;"> 55 </td>
   <td style="text-align:right;"> 0.4387755 </td>
   <td style="text-align:right;"> 22 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> First Priest </td>
   <td style="text-align:right;"> 91 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 8.272727 </td>
   <td style="text-align:right;"> 49 </td>
   <td style="text-align:right;"> 0.4615385 </td>
   <td style="text-align:right;"> 65 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Captain </td>
   <td style="text-align:right;"> 84 </td>
   <td style="text-align:right;"> 38 </td>
   <td style="text-align:right;"> 2.210526 </td>
   <td style="text-align:right;"> 48 </td>
   <td style="text-align:right;"> 0.4285714 </td>
   <td style="text-align:right;"> 53 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Lord </td>
   <td style="text-align:right;"> 67 </td>
   <td style="text-align:right;"> 30 </td>
   <td style="text-align:right;"> 2.233333 </td>
   <td style="text-align:right;"> 39 </td>
   <td style="text-align:right;"> 0.4179104 </td>
   <td style="text-align:right;"> 42 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Reynaldo </td>
   <td style="text-align:right;"> 65 </td>
   <td style="text-align:right;"> 60 </td>
   <td style="text-align:right;"> 1.083333 </td>
   <td style="text-align:right;"> 49 </td>
   <td style="text-align:right;"> 0.2461538 </td>
   <td style="text-align:right;"> 11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Francisco </td>
   <td style="text-align:right;"> 55 </td>
   <td style="text-align:right;"> 45 </td>
   <td style="text-align:right;"> 1.222222 </td>
   <td style="text-align:right;"> 25 </td>
   <td style="text-align:right;"> 0.5454545 </td>
   <td style="text-align:right;"> 14 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> English Ambassador </td>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 10.000000 </td>
   <td style="text-align:right;"> 23 </td>
   <td style="text-align:right;"> 0.4250000 </td>
   <td style="text-align:right;"> 40 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Lucianus </td>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 4.444444 </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.8000000 </td>
   <td style="text-align:right;"> 40 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Messenger </td>
   <td style="text-align:right;"> 36 </td>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:right;"> 2.571429 </td>
   <td style="text-align:right;"> 25 </td>
   <td style="text-align:right;"> 0.3055556 </td>
   <td style="text-align:right;"> 23 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Sailor </td>
   <td style="text-align:right;"> 35 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 3.181818 </td>
   <td style="text-align:right;"> 23 </td>
   <td style="text-align:right;"> 0.3428571 </td>
   <td style="text-align:right;"> 35 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Player prologue </td>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 2.666667 </td>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 0.3750000 </td>
   <td style="text-align:right;"> 16 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Danes </td>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 1.000000 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 0.3076923 </td>
   <td style="text-align:right;"> 5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> All </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 1.000000 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 0.6666667 </td>
   <td style="text-align:right;"> 5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Marcellus and Bernardo </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 1.000000 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 0.3333333 </td>
   <td style="text-align:right;"> 6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Servant </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 1.000000 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 0.3333333 </td>
   <td style="text-align:right;"> 9 </td>
  </tr>
</tbody>
</table>


<object type="image/svg+xml" data='/img/0179-distinctive-words.svg' width='100%'><img src='/img/0179-distinctive-words.png' width='100%'></object>


<object type="image/svg+xml" data='/img/0179-distribution-speeches-length.svg' width='100%'><img src='/img/0179-distribution-speeches-length.png' width='100%'></object>

<object type="image/svg+xml" data='/img/0179-interactions.svg' width='100%'><img src='/img/0179-interactions.png' width='100%'></object>


<object type="image/svg+xml" data='/img/0179-topics.svg' width='100%'><img src='/img/0179-topics.png' width='100%'></object>




{% highlight R lineanchors %}


{% endhighlight %}



{% highlight R lineanchors %}


{% endhighlight %}


{% highlight R lineanchors %}


{% endhighlight %}



{% highlight R lineanchors %}


{% endhighlight %}



{% highlight R lineanchors %}


{% endhighlight %}











